from flask import Flask, request, jsonify
from werkzeug.utils import secure_filename
import os
import whisper
from transformers import pipeline # type: ignore

model = whisper.load_model("small")
pipe = pipeline("summarization", model="Falconsai/medical_summarization")     
app = Flask(__name__)

UPLOAD_FOLDER = './uploads'
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER

if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

@app.route('/transcribe', methods=['POST'])
def transcribe_audio():
    if 'file' not in request.files:
        return jsonify({'error': 'No file uploaded'}), 400
    
    audio_file = request.files['file']
    filename = secure_filename(audio_file.filename)
    file_path = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    audio_file.save(file_path)

    try:
        result = model.transcribe(file_path, prompt= "abscess, acute periradicular, acute apical abscess, chronic periradicular, chronic periapical abscess, abutment, abutment crown, accession, acid etching, adhesion, adhesive, adjunctive, adult dentition, permanent dentition, allogenic, graft, alloplastic, alloy, amalgam, alveolar, alveoloplasty, amalgam, analgesia, anesthesia, anatomical crown, ancillary, anesthesia, analgesia, anxiolysis, deep sedation, general anesthesia, inhalation, intravenous, local anesthesia, minimal sedation, moderate sedation, non-intravenous, regional block anesthesia, trigeminal division block anesthesia, enteral, inhalation, parenteral, transdermal, transmucosal, anomaly, anterior, anxiolysis, anesthesia, apex, apexification, apexogenesis, apicoectomy, arch, dental, arthrogram, artificial crown, autogenous, graft, avulsion, evulsion, barrier membrane, non-autogenous, behavior management, papoose board, benign, bicuspid, bilateral, biologic materials, biopsy, bitewing radiograph, bleaching, bonding, bounded tooth space, tooth bounded space, bridge, fixed partial denture, bruxism, parafunctional, buccal, by report:, calculus, canal, root canal, mandibular canal, cantilever extension, caries, carious lesion, cavity, cast, diagnostic cast, study model, cavity, cement base, cementum, cephalometric image, ceramic, see, porcelain/ceramic, chairside:, direct, Classification of Metals, metals, classification of, cleft palate, clenching, clinical crown, closed reduction, reduction, Code on Dental Procedures and Nomenclature (CDT Code), Current Dental Terminology (CDT), complete denture, complete series, composite, resin, compound fracture, comprehensive oral evaluation:, evaluation, conscious sedation:, minimal sedation, anesthesia, consultation, contiguous, coping, core buildup, coronal, cracked tooth syndrome, crown:, abutment crown, anatomical crown, clinical crown, crown lengthening, culture and sensitivity test, curettage, Current Dental Terminology (CDT), Code on Dental Procedures and Nomenclature, Current Procedural Terminology (CPT), cusp, cuspid, cyst, odontogenic cyst, periapical cyst–, cytology, debridement, decay, deciduous, transitional dentition, deep sedation, anesthesia, definitive, (a), (b), dental assessment, dental prophylaxis, prophylaxis, dentin, dentition, adolescent dentition, primary deciduous (dentition), permanent dentition (adult dentition), transitional dentition–, denture, denture base, diagnostic cast, diagnostic imaging, diastema, direct:, direct pulp cap, direct restoration, discectomy, displaced tooth, distal, dressing, dry socket, edentulous, enamel, enteral, anesthesia, equilibration, evaluation, evulsion, avulsion, excision, exclusions, exfoliative, exostosis, torus, extraoral, extracoronal, extraction, exudate, facial:, fascial, female component, semi, precision attachment, filling, fixed partial denture:, follow-up care, foramen, fracture:, frenum, furcation, general anesthesia:, anesthesia, genetic test, gingiva, gingivectomy, gingivitis, gingivoplasty, glass ionomer:, gold foil, graft, allograft–, autogenous graft–, GTR:, guided tissue regeneration, guided tissue regeneration (GTR), hemisection, histopathology, homologous, graft, hyperplastic, imaging, diagnostic, immediate denture, impacted tooth, implant, dental implant:, endosteal (endosseous), eposteal (subperiosteal), transosteal (transosseous), implant index, radiographic/surgical implant index, implantation, tooth, incisal, incisal angle, incision and drainage, incisor, indigent, indirect, indirect pulp cap, indirect restoration, inhalation, anesthesia, inlay, intentional reimplantation, interim, (a), (b), provisional, temporary, interproximal, intracoronal, intraoral, intravenous:, anesthesia, ISO Tooth Numbering System, Specification No. 3950, jaw, JO, ANSI/ADA/ISO Tooth Numbering System, Specification No. 3950, JP:, Universal/National Tooth Numbering System, keeper or keeper assembly, precision attachment, keratin, keratinized gingiva, labial, facial, laboratory, indirect, laminate veneer, lesion, limited oral evaluation, evaluation, line angle, lingual, local anesthesia, anesthesia, locus, maintenance, periodontal, malar, zygomatic bone, male component, semi, precision attachment, malignant, malocclusion, mandible, Maryland bridge, maxilla, medicament, medicament, topical, membrane, barrier membrane, mesial, metals, classification of, High Noble Alloys, Titanium and Titanium Alloys, Noble Alloys, Predominantly Base Alloys—, microabrasion, microorganisms, minimal sedation:, anesthesia, mixed dentition, transitional dentition, anesthesia, molar, moulage, mouthguard, mucous membrane, non-autogenous, non-intravenous:, anesthesia, normal post-operative follow-up:, follow-up care, obturate, obturator, occlusal, occlusal radiograph, occlusal surface:, occlusion, odontogenic, odontogenic cyst, cyst, odontoplasty, onlay, open reduction, operculectomy, operculum, oral, oral diagnosis, orthognathic, orthotic device, osteitis, dry socket, osteoplasty, osteotomy, overdenture, palate, palliative, panoramic radiograph, papoose board, behavior management, parafunctional, partial denture, periapical, periapical abscess, abscess, periapical cyst, cyst, periapical radiograph, pericoronal, periodic oral evaluation, evaluation, periodontal, periodontal abscess, abscess, periodontal disease, periodontal pocket, periodontics, periodontist, periodontitis, periodontium, periradicular, permanent, definitive, permanent dentition, Dentition, pin, plaque, pontic, porcelain/ceramic, post, posterior, Universal/National tooth numbering system, precision attachment, premedication, premolar, bicuspid, preventive dentistry, primary dentition:, deciduous, dentition, prophylaxis, prosthesis, definitive prosthesis, dental prosthesis, fixed prosthesis, fixed-removable prosthesis–, interim prosthesis, removable prosthesis, provisional, interim, temporary, pulp, pulp cap, direct pulp cap, indirect pulp cap, pulp cavity, pulpectomy, pulpitis, pulpotomy, quadrant, radicular, radiographic/surgical implant index, radiograph, rebase, recalcification, apexification, reduction:, regional block anesthesia:, anesthesia, reimplantation, tooth, reline, removable partial denture, resin, resin-based composite, composite, resin infiltration, retainer:, orthodontic retainer, prosthodontic retainer, retrograde filling, revision, root, residual root, root canal, root canal therapy, root planing, routine follow-up care, follow-up care, routine post-delivery care, follow-up care, routine post-operative care, follow-up care, rubber dam, salivary gland, scaling, sealant, sedation:, anesthesia, sedative filling, semi-precision attachment, sextant, sialodochoplasty:, sialography, sialolithotomy, simple fracture, site, space maintainer, Specification No. 3950, splint, stomatitis, stress breaker, study model, diagnostic cast, succedaneous tooth, supernumerary teeth, suture, temporary, interim, provisional, temporary removable denture, temporomandibular joint (TMJ), temporomandibular joint dysfunction (TMD or TMJD):, TMJD, temporomandibular joint dysfunction, therapeutic, tissue conditioning, TMD, temporomandibular joint dysfunction (TMJD), TMJ, temporomandibular joint, tomography, tooth bounded space, torus, exostosis, tracheotomy, transitional, transitional, transitional dentition, transitional dentition, deciduous, transplantation, transplantation of tooth, transseptal, treatment plan, trigeminal division block anesthesia, anesthesia, trismus, tuberosity, unerupted, unilateral, Universal/National Tooth Numbering System, Permanent Dentition, Primary Dentition, Supernumerary Teeth, veneer, laminate veneer, vertical bitewing:, vertical dimension, vestibuloplasty, viral culture, wax pattern, xerostomia, x-ray, radiograph, yeast, zygomatic bone")
        transcript = result["text"]
        print("Transcript:", transcript)

        summarizer = pipe(transcript, max_length=2000, min_length=1500, do_sample=False)
        print("Summarizer:", summarizer)

        # return jsonify({'transcript': transcript}), 200
        return jsonify({'transcript': transcript, 'summarizer': summarizer[0]['summary_text']}), 200
    except Exception as e:
        return jsonify({'error': str(e)}), 500
    finally:
        if os.path.exists(file_path):
            os.remove(file_path)
if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=5000)
